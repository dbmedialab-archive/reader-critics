box:
  id: dbmedialab/nodejs-openjdk
  cmd: /bin/bash -l

services:
  - name: redis
    id: redis:3.2
  - mongo: mongo
    id: mongo:3.0

js-lint-build-test:
  steps:
  - script:
    name: install dependencies
    code: |
      npm config set cache $WERCKER_CACHE_DIR/wercker/npm
      npm install
      #  - script:
      #    name: lint
      #    code: run/lint
      #  - script:
      #    name: check node
      #    code: node --version
      #  - script:
      #    name: build
      #    code: run/build
  - script:
    name: set db envs
    code: |
      export MONGODB_URL="mongodb://$MONGO_PORT_27017_TCP_ADDR:$MONGO_PORT_27017_TCP_PORT/readercritics"
      export REDIS_URL_MESSAGE_QUEUE="redis://$REDIS_PORT_6379_TCP_ADDR:$REDIS_PORT_6379_TCP_PORT/1"
      export REDIS_URL_SESSION_CACHE="redis://$REDIS_PORT_6379_TCP_ADDR:$REDIS_PORT_6379_TCP_PORT/2"
      echo $MONGODB_URL $REDIS_URL_MESSAGE_QUEUE $REDIS_URL_SESSION_CACHE
  - script:
    name: test libraries
    code: run/test --libs
  - script:
    name: test base modules
    code: run/test --base
  - script:
    name: test backend app
    code: run/test --app
  - script:
    name: test db services
    code: run/test --db

deploy:
  box:
    no-response-timeout: 15
    id: eu.gcr.io/dagbladet-projects/kubectl
    username: _json_key
    password: $GCR_DBP_JSON_KEY_FILE
    registry: https://eu.gcr.io
  steps:
  - script:
    name: build container
    code: buildimage
